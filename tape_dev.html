<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Infinite tape</title>

<!-- <script src="build/turingmachine.js" type="text/javascript"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<style>
.tape-cell rect {
  fill: white;
  stroke: gray;
}

#tape-head {
  fill: none;
  stroke: gold;
}

text {
  stroke: black;
  pointer-events: none;
  text-anchor: middle;
  font-family: "Source Code Pro", "Courier", monospace;
  font-size: 25px;
}
</style>

</head>
<body>
<script type="text/javascript">
'use strict';

function last(array) {
  return array[array.length - 1];
}

function isEmpty(array) {
  return array.length === 0;
}

function Tape   (blank   , input           ) {
  this.__defineGetter__("blank", function() { return blank; });
  // INVARIANTS: tape.before can be empty, tape.after must be nonempty.
  // before: cells before the head (in order).
  // after:  cells after and including the head (in reverse order).
  this.tape =
    { before: [],
      after: (input == undefined) ? [blank] : input.slice().reverse(),
      toString: function() {
        return this.before.join('')+'ðŸ”Ž'+this.after.slice().reverse().join('');
      }
    };
}

Tape.prototype.read = function() {
  return this.tape.after[this.tape.after.length-1];
};
Tape.prototype.write = function(symbol) {
  this.tape.after[this.tape.after.length-1] = symbol;
};

Tape.prototype.headRight = function() {
  var before = this.tape.before, after = this.tape.after;
  before.push(after.pop());
  if (isEmpty(after)) { after.push(this.blank); }
};
Tape.prototype.headLeft = function() {
  var before = this.tape.before, after = this.tape.after;
  if (isEmpty(before)) { before.push(this.blank); }
  after.push(before.pop());
};

Tape.prototype.toString = function() { return this.tape.toString(); };

// for tape visualization. not part of TM definition.
// Read an offset from the tape head. 0 is the tape head. + is to the right, - to the left.
Tape.prototype.readOffset = function(i) {
  var tape = this.tape;
  if (i >= 0) {
    // right side: offset [0..length-1] â†¦ index [length-1..0]
    return (i <= tape.after.length-1) ? tape.after[tape.after.length-1-i] : this.blank;
  } else {
    // left side: offset [-1..-length] â†¦ index [length-1..0]
    return (-i <= tape.before.length) ? tape.before[tape.before.length+i] : this.blank;
  }
};

// range, inclusive.
Tape.prototype.readRange = function(start, end) {
  // TODO: replace with more efficent version
  return d3.range(start, end+1).map(function(i) { return this.readOffset(i); }, this);
};

</script>

<script type="text/javascript">
'use strict';

var cellWidth = 50;
var cellHeight = 50;

function appendCellContents(selection) {
  selection.append('rect')
    // remove data binding since the outline is purely visual
    .datum(null)
    .attr({'width': cellWidth, 
           'height': cellHeight});
  selection.append('text')
    .text(function(d) { return d; })
    .attr({'x': cellWidth/2, 'y': cellHeight/2 + 8});
}

function TapeViz(svg, blank, input, lookaround) {
  Tape.call(this, blank, input);

  lookaround = (lookaround == undefined) ? 11 : lookaround;
  this.__defineGetter__('lookaround', function() { return lookaround; });

  this.wrapper = svg.append('g');

  var tapeHead = svg.append('rect')
      .attr({'id': 'tape-head',
             'width': cellWidth+10,
             'height': cellHeight+10,
             'x': 10/2 + cellWidth*(lookaround-1),
             'y': 10/2
           });

  var cells = this.wrapper.selectAll('.tape-cell')
      .data(this.readRange(-lookaround, lookaround))
      .enter()
      .append('g')
      .attr({'class': 'tape-cell',
             'transform': function(d, i) { return 'translate(' + (-50+10 + cellWidth*i) + ' 10)'; }
           });

  appendCellContents(cells);
}

TapeViz.prototype = Object.create(Tape.prototype);
TapeViz.prototype.constructor = TapeViz;

// TODO: concurrently fade out old value and fade in new value
TapeViz.prototype.write = function(symbol) {
  // var previous = this.prototype.read();
  Tape.prototype.write.call(this, symbol);
  d3.select(this.wrapper[0][0].childNodes[this.lookaround])
    .datum(symbol)
    .select('text')
    .attr('fill-opacity', '1')
    .attr('stroke-opacity', '1')
    .transition()
      .attr('fill-opacity', '0.4')
      .attr('stroke-opacity', '0.1')
    .transition()
      .text(function(d) { return d; })
      .attr('fill-opacity', '1')
      .attr('stroke-opacity', '1')
    .transition()
      .duration(0)
      .attr('fill-opacity', null)
      .attr('stroke-opacity', null)
    ;
}

// FIXME: loses sync with display when called in rapid succession; eg. for-loop
// d3 transitions get interrupted
TapeViz.prototype.headRight = function() {
  Tape.prototype.headRight.call(this);
    // add to right end
  var tapeView = this.wrapper.append('g')
    .datum(this.readOffset(this.lookaround))
    .attr({'class': 'tape-cell'})
    .call(appendCellContents);

  // shift all cells leftwards, but translate wrapper rightwards to compensate
  this.wrapper.selectAll('.tape-cell')
    .attr('transform', function(d, i) {
            return 'translate(' + (-50+10+cellWidth*(i-1)).toString() + ' 10)';
          });
  this.wrapper
      .attr('transform', 'translate(' + cellWidth.toString() + ')')
    .transition()
      .attr('transform', 'translate(0)')
    .transition()
      .duration(0)
      .attr('transform', null)
      .select('.tape-cell')
        .remove();
}

TapeViz.prototype.headLeft = function() {
  Tape.prototype.headLeft.call(this);
    // add to right end
  var tapeView = this.wrapper.insert('g', ':first-child')
    .datum(this.readOffset(-this.lookaround))
    .attr({'class': 'tape-cell'})
    .call(appendCellContents);

  // translate cells rightward, and wrapper leftward. animate wrapper going right.
  this.wrapper.selectAll('.tape-cell')
    .attr('transform', function(d, i) {
            return 'translate(' + (-50+10+cellWidth*i).toString() + ' 10)';
          });
  this.wrapper
      .attr('transform', 'translate(' + (-cellWidth).toString() + ')')
    .transition()
      .attr('transform', 'translate(0)')
    .transition()
      .duration(0)
      .attr('transform', null)
      .node()
        .lastChild
        .remove()
  ;
}

var lookaround = 5;

// width for before + head + after, trimming 2 off to show cut-off tape ends
var w = cellWidth * (lookaround+1+lookaround-2) + 20;
var h = cellHeight+20;

var svg = d3.select('body').append('svg').attr({'width': w, 'height': h});

var t1 = new TapeViz(svg, ' ', 'Hello World'.split(''), lookaround);

</script>

</body>
</html>

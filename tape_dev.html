<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>Infinite tape</title>

<link href='tape/tape.css' rel='stylesheet' />
<style>
#run-step {
  padding: 4px 12px 6px 12px;
}
</style>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js' charset='utf-8'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js' charset='utf-8'></script>
</head>

<body>

<script src='tape/Tape.js' type='text/javascript'></script>
<script src='tape/TapeViz.js' type='text/javascript'></script>

<script type='text/javascript'>
'use strict';
function makeTransition(obj) {
  return function(s, sym) {
    var sym2res = obj[s];
    if (sym2res == undefined) {
      throw new Error('no transitions are defined from state: ' + s.toString());
    }
    var res = sym2res[sym];
    res = (res == undefined) ? sym2res['_'] : res;
    if (res == undefined) {
      throw new Error('no transition is defined from state ' + s.toString() + ' for symbol '+ sym.toString());
    }
    return res(s, sym);
  }
}

// TODO: include state in TM.toString()
function TuringMachine(transition, initialState, tape) {
  this.transition = transition;
  this.state = initialState;
  this.tape = tape;
}

TuringMachine.prototype.step = function() {
  var result = this.transition(this.state, this.tape.read());
  this.state = result[0];
  this.tape.write(result[1]);
  if (result[2]) { this.tape.headRight(); } else { this.tape.headLeft(); }
}
</script>
<script type='text/javascript'>
function write(sym, dir, state) {
  return function () {
    return [state, sym, dir];
  };
}

function move(dir, state) {
  return function(_, sym) {
    return [state, sym, dir];
  };
}

function skip(dir) {
  return function(state, sym) {
    return [state, sym, dir];
  }
}

var R = true;
var L = false;

var accept = move(R, 'accept');
var reject = move(R, 'reject');

// TODO: check if assigning x and _ cause problems
var m2lookup =
  { q1: {
      '0': write(' ', R, 'q2'),
      '_': reject
    },
    q2: {
      '0': write('x', R, 'q3'),
      ' ': accept,
      'x': skip(R)
    },
    q3: {
      '0': move(R, 'q4'),
      ' ': move(L, 'q5'),
      'x': skip(R)
    },
    q4: {
      '0': write('x', R, 'q3'),
      ' ': reject,
      'x': skip(R)
    },
    q5: {
      ' ': move(R, 'q2'),
      '_': skip(L)
    },
    'accept': null,
    'reject': null
  };

var svg = d3.select('body').append('svg')
var m2input = '0000';
var m2tape = new TapeViz(svg, 5, ' ', m2input.split(''));
var m2 = new TuringMachine(makeTransition(m2lookup), 'q1', m2tape);
</script>

<div>
  <button id='run-step'>Step</button>
  <noscript><strong>Tip: to enable this visualization, enable JavaScript.</strong></noscript>
</div>

<script type='text/javascript'>
document.getElementById('run-step').addEventListener('click', function() {
  m2.step();
});
</script>

</body>
</html>

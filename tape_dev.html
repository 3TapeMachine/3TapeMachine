<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Infinite tape</title>

<!-- <script src="build/turingmachine.js" type="text/javascript"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<style>
.tape-cell rect {
  fill: white;
  stroke: gray;
}

#tape-head {
  fill: none;
  stroke: gold;
}

text {
  stroke: black;
  pointer-events: none;
  text-anchor: middle;
  font-family: "Source Code Pro", "Courier", monospace;
  font-size: 25px;
}
</style>

</head>
<body>
<script type="text/javascript">
'use strict';

function last(array) {
  return array[array.length - 1];
}

function isEmpty(array) {
  return array.length === 0;
}

function Tape   (blank   , input           ) {
  this.__defineGetter__("blank", function() { return blank; });
  // INVARIANTS: tape.before can be empty, tape.after must be nonempty.
  // before: cells before the head (in order).
  // after:  cells after and including the head (in reverse order).
  this.tape =
    { before: [],
      after: (input == undefined) ? [blank] : input.slice().reverse(),
      toString: function() {
        return this.before.join('')+'ðŸ”Ž'+this.after.slice().reverse().join('');
      }
    };
}

Tape.prototype.read = function() {
  return this.tape.after[this.tape.after.length-1];
};
Tape.prototype.write = function(symbol) {
  this.tape.after[this.tape.after.length-1] = symbol;
};

Tape.prototype.headRight = function() {
  var before = this.tape.before, after = this.tape.after;
  before.push(after.pop());
  if (isEmpty(after)) { after.push(this.blank); }
};
Tape.prototype.headLeft = function() {
  var before = this.tape.before, after = this.tape.after;
  if (isEmpty(before)) { before.push(this.blank); }
  after.push(before.pop());
};

Tape.prototype.toString = function() { return this.tape.toString(); };

// for tape visualization. not part of TM definition.
// Read an offset from the tape head. 0 is the tape head. + is to the right, - to the left.
Tape.prototype.readOffset = function(i) {
  var tape = this.tape;
  if (i >= 0) {
    // right side: offset [0..length-1] â†¦ index [length-1..0]
    return (i <= tape.after.length-1) ? tape.after[tape.after.length-1-i] : this.blank;
  } else {
    // left side: offset [-1..-length] â†¦ index [length-1..0]
    return (-i <= tape.before.length) ? tape.before[tape.before.length+i] : this.blank;
  }
};

</script>
<script type="text/javascript">
'use strict';
var cellWidth = 50;
var cellHeight = 50;

var offset = 0;

var message = 'Hello World!';

var w = 1000;
var h = cellHeight+20;

var svg = d3.select('body').append('svg').attr({'width': w, 'height': h});

var wrapper = svg.append('g');

var tapeHead = svg.append('rect')
    .attr({'id': 'tape-head',
           'width': cellWidth+10,
           'height': cellHeight+10,
           'x': 10/2 + cellWidth*5,
           'y': 10/2
         });

var cells = wrapper.selectAll('.tape-cell')
    .data(message.split(''))
    .enter()
    .append('g')
    .attr({'class': 'tape-cell',
           'transform': function(d, i) { return 'translate(' + (10 + cellWidth*i) + ' 10)'; }
         });

var cellBoxes = cells.append('rect')
    .attr({'width': cellWidth,
           'height': cellHeight});

var cellLabels = cells.append('text')
    .text(function(d) { return d; })
    .attr({'x': cellWidth/2, 'y': cellHeight/2 + 8})

// function TapeViz(blank, input, svg, cellMargin) {
//   Tape.call(this, blank, input);

//   this.svg = svg;
//   // allow translating the whole tape view
//   var wrapper = svg.append('g');

//   var tapeHead = svg.append('rect')
//       .attr({'id': 'tape-head',
//              'width': cellWidth+10,
//              'height': cellHeight+10,
//              'x': 10/2 + cellWidth*5,
//              'y': 10/2
//            });

//   var cells = wrapper.selectAll('.tape-cell')
//       .data(message.split(''))
//       .enter()
//       .append('g')
//       .attr({'class': 'tape-cell',
//              'transform': function(d, i) { return 'translate(' + (10 + cellWidth*i) + ' 10)'; }
//            });

//   var cellBoxes = cells.append('rect')
//       .attr({'width': cellWidth,
//              'height': cellHeight});

//   var cellLabels = cells.append('text')
//       .text(function(d) { return d; })
//       .attr({'x': cellWidth/2, 'y': cellHeight/2 + 8})

//   this.read = this.prototype.
// }

// TapeViz.prototype = Object.create(Tape.prototype);
// TapeViz.prototype.constructor = TapeViz;

// TapeViz.prototype.write = function(symbol) {

// }

// TapeViz.prototype.moveRight = function() {

// }

var testTape = new Tape(' ', 'Hello World!'.split(''));

function appendBox(sel) {
  sel.append('rect')
    .attr({'width': cellWidth,
           'height': cellHeight});
}

function moveRight() {
  // add to right end
  var tapeView = svg.select('svg > g').append('g')
    .attr({'class': 'tape-cell'})
    .call(appendBox)
    .append('text')
    .text('x')
    .attr({'x': cellWidth/2, 'y': cellHeight/2 + 8});

  // shift all cells leftwards, but translate wrapper rightwards to compensate
  svg.selectAll('.tape-cell')
    .attr('transform', function(d, i) {
            return 'translate(' + (10+cellWidth*(i-1)).toString() + ' 10)';
          });
  wrapper
      .attr('transform', 'translate(' + cellWidth.toString() + ')')
    .transition()
      .duration(400)
      .attr('transform', 'translate(0)')
    .each('end', function() {
         // remove from left end (off-screen)
         wrapper.select('.tape-cell').remove()
      })
    .transition()
      .attr('transform', null);
}
// internal function
// function moveOffset(n) {
//   offset += n;
//   wrapper.transition()
//     .attr('transform', 'translate(' + (offset * -cellWidth) + ')');
// }

// function moveRight() {
//   moveOffset(1);
// }

// function moveLeft() {
//   moveOffset(-1);
// }



</script>

</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>Turing machine visualization</title>

<!-- 
<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js' type='text/javascript'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js' charset='utf-8'></script>
-->
<script src='lib/underscore.js' type='text/javascript'></script>
<script src='lib/d3.js' type='text/javascript'></script>

<script src='tape/Tape.js' type='text/javascript'></script>
<script src='tape/TapeViz.js' type='text/javascript'></script>

<script src='util.js' type='text/javascript'></script>
<script src='TuringMachine.js' type='text/javascript'></script>

<script src='StateViz.js' type='text/javascript'></script>
<script src='NodesLinks.js' type='text/javascript'></script>

<script src='Examples.js' type='text/javascript'></script>

<link href='StateViz.css' rel='stylesheet' />
<link href='tape/tape.css' rel='stylesheet' />
<style>
.run-step {
  padding: 0.5em 1em 0.6em 1em;
  /*display: block;*/
  margin: 1em;
}
</style>
</head>

<body>

<noscript><strong>Tip: to enable this visualization, enable JavaScript.</strong></noscript>

<script type='text/javascript'>

// Animate each transition's edge
// TODO: factor out
// FIXME: missing null checks, like for .withSymbol

// TODO: decompose into lookup edge
function makeTransitionViz(stateMap, callback) {
  return function(s, sym) {
    var stateObj = stateMap[s];
    if (stateObj === undefined) {
      throw new Error('not a valid state: ' + String(s));
    }
    var symbolMap = stateObj.withSymbol;
    if (symbolMap === null) {
      throw new Error('the machine has already reached a halting state: ' + String(s));
    }
    var edgeObj = symbolMap[sym];
    // try wildcard if not matched
    edgeObj = (edgeObj === undefined) ? symbolMap['_'] : edgeObj;
    if (edgeObj == null) {
      throw new Error('no transition is defined from state ' + String(s) + ' for symbol '+ String(sym));
    }

    callback(edgeObj.edge);
    return interpretAction(s, sym, edgeObj.action);
  };
}

// sample animation for edges.
// returns the last chained transition.
function pulseEdgeSample(edge) {
  var edgepath = d3.select(edge.domNode);
  // workaround for https://github.com/d3/d3-transition/issues/11
  var normalColor = edgepath.style('stroke');
  var pulseColor = d3.select('#active-arrowhead').style('stroke');
  // TODO: animate arrowhead as well
  return edgepath
      .classed('active-edge', true)
    .transition()
      .style('stroke', pulseColor)
      .style('stroke-width', '3')
    .transition()
      .style('stroke', normalColor)
      .style('stroke-width', '1')
    .transition()
      .duration(0)
      .each('start', function() { d3.select(this).classed('active-edge', false) })
      .style('stroke', null)
      .style('stroke-width', null);
}

// TODO: machine spec checker:
// * typeof table should be object, not function.
// * each non-halting state should cover all symbol cases

// construct a new state and tape visualization inside the 'div' selection.
function constructMachine(div, spec) {
  var dataset = deriveNodesLinks(spec.table);
  visualizeState(div.append('svg'), dataset.nodes, dataset.edges);

  function addTape() {
    return new TapeViz(div.insert('svg', 'button').attr('class', 'tm-tape'), 7, spec.blank, spec.input.split(''));
  }
  var stateMap = dataset.stateMap;
  // FIXME: factor out this experimental code.
  var machine;
  var delayBetweenSteps = 100;
  function edgeCallback(edge) {
    var transition = pulseEdgeSample(edge);
    // TODO: bind machine.isRunning to the run button's text
    transition.transition().duration(delayBetweenSteps).each('end', function() {
      if (machine.isRunning) {
        try {
          machine.step();
          // FIXME: specialize to rethrow if not HaltError
        } catch (e) {
          machine.isRunning = false;
          console.log(e);
        }
      }
    });
  }

  machine = new TuringMachine(makeTransitionViz(stateMap, edgeCallback), spec.startState, addTape());
  // FIXME: experimental. override TuringMachine.state
  machine.__state = machine.state;
  Object.defineProperty(machine, 'state', {
    get: function() { return this.__state; },
    set: function(s) {
      d3.select(stateMap[this.__state].domNode).classed('current-state', false);
      this.__state = s;
      d3.select(stateMap[s].domNode).classed('current-state', true);
    }
  });
  machine.state = machine.__state;

  var isRunning = false;
  Object.defineProperty(machine, 'isRunning', {
    get: function() { return isRunning; },
    set: function(value) {
      isRunning = value;
      if (isRunning) { this.step(); }
    }
  })

  // FIXME: bind isRunning to update Run/Pause button
  machine.reset = function() {
    machine.isRunning = false;
    machine.state = spec.startState;
    // div.selectAll('svg.tm-tape').remove();
    machine.tape.domNode.remove();
    machine.tape = addTape();
  }

  return machine;
}

var divs = d3.select('body')
  .selectAll('div.machine')
    .data([ExampleTMs.powersOfTwo], function(d) { return d.name; });

divs.exit().remove();

divs.enter()
  .append('div')
    .attr('class', 'machine')
    .each(function(d) {
      var div = d3.select(this);
      div.append('h3')
          .text(function(d) { return d.name; });

      var machine = constructMachine(div, d);
      this.__machine = machine;

      // FIXME: step causing chain reaction when isRunning
      div.append('button')
          .text('Step')
          .attr('class', 'run-step')
        .node()
          .addEventListener('click', function() { machine.step(); });

      div.append('button')
          .text('Run')
          .attr('class', 'run-step')
        .call(function(selection) {
          selection.node().addEventListener('click', function() {
            machine.isRunning = !machine.isRunning;
            selection.text(machine.isRunning ? 'Pause' : 'Run');
          });
        });

      div.append('button')
          .text('Reset')
          .attr('class', 'run-step')
          .style('float', 'right')
        .node()
          .addEventListener('click', function() { machine.reset(); });
    });

</script>

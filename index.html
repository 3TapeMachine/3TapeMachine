<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>Turing machine visualization</title>

<!-- 
<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js' type='text/javascript'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js' charset='utf-8'></script>
-->
<script src='lib/underscore.js' type='text/javascript'></script>
<script src='lib/d3.js' type='text/javascript'></script>

<script src='tape/Tape.js' type='text/javascript'></script>
<script src='tape/TapeViz.js' type='text/javascript'></script>

<script src='util.js' type='text/javascript'></script>
<script src='TuringMachine.js' type='text/javascript'></script>

<script src='StateViz.js' type='text/javascript'></script>
<script src='NodesLinks.js' type='text/javascript'></script>

<link href='StateViz.css' rel='stylesheet' />
<link href='tape/tape.css' rel='stylesheet' />
<style>
.run-step {
  padding: 4px 12px 6px 12px;
  display: block;
  margin: auto;
}
</style>
</head>

<body>

<noscript><strong>Tip: to enable this visualization, enable JavaScript.</strong></noscript>

<script type='text/javascript'>

// Animate each transition's edge
// TODO: factor out
// FIXME: missing null checks, like for .withSymbol

// TODO: decompose into lookup edge
function makeTransitionViz(stateMap, callback) {
  return function(s, sym) {
    var stateObj = stateMap[s];
    if (stateObj === undefined) {
      throw new Error('not a valid state: ' + String(s));
    }
    var symbolMap = stateObj.withSymbol;
    if (symbolMap === null) {
      throw new Error('the machine has already reached a halting state: ' + String(s));
    }
    var edgeObj = symbolMap[sym];
    // try wildcard if not matched
    edgeObj = (edgeObj === undefined) ? symbolMap['_'] : edgeObj;
    if (edgeObj == null) {
      throw new Error('no transition is defined from state ' + String(s) + ' for symbol '+ String(sym));
    }

    callback(edgeObj.edge);
    return interpretAction(s, sym, edgeObj.action);
  };
}

// sample animation for edges
function pulseEdgeSample(edge) {
  var edgepath = d3.select(edge.domNode);
  // workaround for https://github.com/d3/d3-transition/issues/11
  var normalColor = edgepath.style('stroke');
  var pulseColor = d3.select('#active-arrowhead').style('stroke');
  // TODO: animate arrowhead as well
  edgepath
      .classed('active-edge', true)
    .transition()
      .style('stroke', pulseColor)
      .style('stroke-width', '3')
    .transition()
      .style('stroke', normalColor)
      .style('stroke-width', '1')
    .transition()
      .duration(0)
      .each('end', function() { d3.select(this).classed('active-edge', false) })
      .style('stroke', null)
      .style('stroke-width', null);
}

var powersOfTwo = {
  name: 'powers of two',
  input: '0000',
  blank: ' ',
  startState: 'q1',
  table: (function() {
    // convenient synonyms
    var L = MoveHead.left;
    var R = MoveHead.right;

    var accept = move(R, 'accept');
    var reject = move(R, 'reject');

    // transition function
    return Object.freeze({
      q1: {
        '0': write(' ', R, 'q2'),
        '_': reject
      },
      q2: {
        '0': write('x', R, 'q3'),
        ' ': accept,
        'x': skip(R)
      },
      q3: {
        '0': move(R, 'q4'),
        ' ': move(L, 'q5'),
        'x': skip(R)
      },
      q4: {
        '0': write('x', R, 'q3'),
        ' ': reject,
        'x': skip(R)
      },
      q5: {
        ' ': move(R, 'q2'),
        '_': skip(L)
      },
      'accept': null,
      'reject': null
    });
  })()
};

var busyBeaver3 = {
  name: '3-state busy beaver',
  input: '',
  blank: 0,
  startState: 'A',
  table: (function() {
    var L = MoveTape.left;
    var R = MoveTape.right;
    var halt = move(R, 'halt');
    return Object.freeze({
      A: {
        0: write(1, R, 'B'),
        1: move(L, 'C')
      },
      B: {
        0: write(1, L, 'A'),
        1: skip(R)
      },
      C: {
        0: write(1, L, 'B'),
        1: halt
      },
      halt: null
    });
  })()
};

var busyBeaver3alt = {
  name: '3-state busy beaver (alternate)',
  input: '',
  blank: 0,
  startState: 'A',
  table: (function() {
    var L = MoveHead.left;
    var R = MoveHead.right;
    var halt = move(R, 'halt')
    return Object.freeze({
      A: {
        0: write(1, R, 'B'),
        1: halt
      },
      B: {
        0: move(R, 'C'),
        1: skip(R)
      },
      C: {
        0: write(1, L, 'C'),
        1: move(L, 'A')
      },
      halt: null
    });
  })()
}

var busyBeaver4 = {
  name: '4-state busy beaver',
  input: '',
  blank: 0,
  startState: 'A',
  table: (function() {
    var L = MoveHead.left;
    var R = MoveHead.right;
    return Object.freeze({
      A: {0: write(1, R, 'B'), 1: move(L, 'B')},
      B: {0: write(1, L, 'A'), 1: write(0, L, 'C')},
      C: {0: write(1, R, 'H'), 1: move(L, 'D')},
      D: {0: write(1, R, 'D'), 1: write(0, R, 'A')},
      H: null
    });
  })()
};

// repeat01 and copy1s are from
// https://en.wikipedia.org/wiki/Turing_machine_examples
var repeat01 = {
  name: 'repeat 0 1',
  input: '',
  blank: ' ',
  startState: 'b',
  table: (function() {
    var R = MoveHead.right;
    return Object.freeze({
      b: {' ': write(0, R, 'c')},
      c: {' ': move(R, 'e')},
      e: {' ': write(1, R, 'f')},
      f: {' ': move(R, 'b')}
    });
  })()
};

var copy1s = {
  name: 'copy 1s',
  input: '111',
  blank: '0',
  startState: 's1',
  table: (function() {
    var L = MoveHead.left;
    var R = MoveHead.right;
    var halt = move(R, 'H');
    return Object.freeze({
      s1: {
        0: halt,
        1: write(0, R, 's2')
      },
      s2: {
        0: move(R, 's3'),
        1: skip(R)
      },
      s3: {
        0: write(1, L, 's4'),
        1: skip(R)
      },
      s4: {
        0: move(L, 's5'),
        1: skip(L)
      },
      s5: {
        0: write(1, R, 's1'),
        1: skip(L)
      },
      H: null
    });
  })()
};

var binaryIncrement = {
  name: 'binary increment',
  input: '1011',
  blank: ' ',
  startState: 'right',
  table: (function() {
    var L = MoveHead.left;
    var R = MoveHead.right;
    return Object.freeze({
      'right': {
        0: skip(R),
        1: skip(R),
        ' ': move(L, 'inc')
      },
      'inc': {
        1: write(0, L, 'inc'),
        0: write(1, R, 'done'),
        ' ': write(1, R, 'done')
      },
      'done': null
    });
  })()
};

// TODO: machine spec checker:
// * typeof table should be object, not function.
// * each non-halting state should cover all symbol cases

// construct a new state and tape visualization inside the 'div' selection.
function constructMachine(div, spec) {
  var dataset = deriveNodesLinks(spec.table);
  visualizeState(div.append('svg'), dataset.nodes, dataset.edges);

  var tape = new TapeViz(div.append('svg'), 7, spec.blank, spec.input.split(''));
  var stateMap = dataset.stateMap;
  var machine = new TuringMachine(makeTransitionViz(stateMap, pulseEdgeSample), spec.startState, tape);
  // FIXME: experimental. override TuringMachine.state
  machine.__state = machine.state;
  Object.defineProperty(machine, 'state', {
    get: function() { return this.__state; },
    set: function(s) {
      d3.select(stateMap[this.__state].domNode).classed('current-state', false);
      this.__state = s;
      d3.select(stateMap[s].domNode).classed('current-state', true);
    }
  });
  machine.state = machine.__state;
  return machine;
}

var divs = d3.select('body')
  .selectAll('div.machine')
    .data([powersOfTwo], function(d) { return d.name; });

divs.exit().remove();

divs.enter()
  .append('div')
    .attr('class', 'machine')
    .each(function(d) {
      var div = d3.select(this);
      div.append('h3')
          .text(function(d) { return d.name; });

      var machine = constructMachine(div, d);
      this.__machine = machine;

      div.append('button')
          .text('Step')
          .attr('class', 'run-step')
        .node()
          .addEventListener('click', function() { machine.step(); });
    });

</script>

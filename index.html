<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>Turing machine visualization</title>

<!-- 
<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js' type='text/javascript'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js' charset='utf-8'></script>
-->
<script src='lib/underscore.js' type='text/javascript'></script>
<script src='lib/d3.js' type='text/javascript'></script>

<script src='tape/Tape.js' type='text/javascript'></script>
<script src='tape/TapeViz.js' type='text/javascript'></script>

<script src='util.js' type='text/javascript'></script>
<script src='TuringMachine.js' type='text/javascript'></script>

<script src='StateViz.js' type='text/javascript'></script>
<script src='NodesLinks.js' type='text/javascript'></script>

<link href='StateViz.css' rel='stylesheet' />
<link href='tape/tape.css' rel='stylesheet' />
<style>
.run-step {
  padding: 4px 12px 6px 12px;
  display: block
}
</style>
</head>

<body>

<noscript><strong>Tip: to enable this visualization, enable JavaScript.</strong></noscript>

<script type='text/javascript'>

// Animate each transition's edge
// TODO: factor out
// FIXME: missing null checks, like for .withSymbol

// TODO: decompose into lookup edge
function makeTransitionViz(stateMap, callback) {
  return function(s, sym) {
    var stateObj = stateMap[s];
    if (stateObj === null) {
      throw new Error('the machine has already reached a halting state: ' + String(s));
    }
    if (stateObj === undefined) {
      throw new Error('not a valid state: ' + String(s));
    }
    var symbolMap = stateObj.withSymbol;
    var edgeObj = symbolMap[sym];
    // try wildcard if not matched
    edgeObj = (edgeObj === undefined) ? symbolMap['_'] : edgeObj;
    if (edgeObj == null) {
      throw new Error('no transition is defined from state ' + String(s) + ' for symbol '+ String(sym));
    }

    callback(edgeObj.edge);
    return interpretAction(s, sym, edgeObj.action);
  };
}

// sample animation for edges
function pulseEdgeSample(edge) {
  var edgepath = d3.select(edge.domNode);
  // workaround for https://github.com/d3/d3-transition/issues/11
  var normalColor = edgepath.style('stroke');
  var pulseColor = d3.select('#active-arrowhead').style('stroke');
  edgepath
    .transition()
      // TODO: animate arrowhead as well
      .style('marker-end', 'url(#active-arrowhead)')
      .style('stroke', pulseColor)
      .style('stroke-width', '3')
    .transition()
      .style('stroke', normalColor)
      .style('stroke-width', '1')
    .transition()
      .duration(0)
      .style('marker-end', null)
      .style('stroke', null)
      .style('stroke-width', null);
}

var powersOfTwo = {
  name: 'powers of two',
  input: '0000',
  blank: ' ',
  startState: 'q1',
  table: (function() {
    // convenient synonyms
    var L = MoveHead.left;
    var R = MoveHead.right;

    var accept = move(R, 'accept');
    var reject = move(R, 'reject');

    // transition function
    return Object.freeze({
      q1: {
        '0': write(' ', R, 'q2'),
        '_': reject
      },
      q2: {
        '0': write('x', R, 'q3'),
        ' ': accept,
        'x': skip(R)
      },
      q3: {
        '0': move(R, 'q4'),
        ' ': move(L, 'q5'),
        'x': skip(R)
      },
      q4: {
        '0': write('x', R, 'q3'),
        ' ': reject,
        'x': skip(R)
      },
      q5: {
        ' ': move(R, 'q2'),
        '_': skip(L)
      },
      'accept': null,
      'reject': null
    });
  })()
};

// construct a new state and tape visualization inside the 'div' selection.
function constructMachine(div, spec) {
  var dataset = deriveNodesLinks(spec.table);
  var stateMap = dataset.stateMap;
  visualizeState(div.append('svg'), dataset.nodes, dataset.edges);

  var tape = new TapeViz(div.append('svg'), 5, spec.blank, spec.input.split(''));
  var machine = new TuringMachine(makeTransitionViz(stateMap, pulseEdgeSample), spec.startState, tape);
  // FIXME: experimental. override TuringMachine.state
  machine.__state = machine.state;
  Object.defineProperty(machine, 'state', {
    get: function() { return this.__state; },
    set: function(s) {
      d3.select(stateMap[this.__state].domNode).classed('current-state', false);
      this.__state = s;
      d3.select(stateMap[s].domNode).classed('current-state', true);
    }
  });
  machine.state = machine.__state;
  return machine;
}

var divs = d3.select('body')
  .selectAll('div.machine')
    .data([powersOfTwo], function(d) { return d.name; });

divs.exit().remove();

divs.enter()
  .append('div')
    .attr('class', 'machine')
    .each(function(d) {
      var div = d3.select(this);
      var machine = constructMachine(div, d);
      this.__machine = machine;

      div.append('button')
          .text('Step')
          .attr('class', 'run-step')
        .node()
          .addEventListener('click', function() { machine.step(); });
    });

</script>
